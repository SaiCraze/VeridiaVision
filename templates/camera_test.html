<!DOCTYPE html>
<html lang="en" class=""> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veridia Vision - Gemini 2.5 Flash Testing (Camera)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Inter font globally */
        body {
            font-family: 'Inter', sans-serif;
            /* Smooth transition for background color */
            transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out;
        }
        /* Style video element */
        video {
            display: block; /* Prevent extra space below video */
            width: 100%;   /* Make video fill container width */
            height: auto;  /* Maintain aspect ratio */
            transform: scaleX(-1); /* Mirror the video feed */
            /* Lighter background for light mode */
            background-color: #e5e7eb; /* bg-gray-200 */
            transition: background-color 0.3s ease-in-out;
        }
        .dark video {
             background-color: #000000; /* black */
        }

        /* Add a subtle animation for the loading indicator */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        .dark .spinner {
             border: 2px solid rgba(255, 255, 255, 0.1);
             border-left-color: #60a5fa; /* blue-400 */
        }

        /* Hide the canvas used for snapshots */
        #snapshotCanvas {
            display: none;
        }

        /* --- Dark Mode Toggle Styles --- */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
        }
        .theme-switch {
            display: inline-block;
            height: 26px; /* Height of the switch */
            position: relative;
            width: 50px; /* Width of the switch */
            flex-shrink: 0; /* Prevent switch from shrinking in flex container */
        }
        .theme-switch input {
            display: none; /* Hide the default checkbox */
        }
        .slider {
            background-color: #cbd5e1; /* gray-300 */
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: background-color 0.3s ease-in-out;
            border-radius: 26px; /* Fully rounded */
            display: flex;
            align-items: center;
            justify-content: space-between; /* Distribute icons */
            padding: 0 4px; /* Padding for icons */
        }
        .slider:before { /* This is the sliding circle */
            background-color: #ffffff; /* white */
            bottom: 3px; /* Position inside the slider */
            content: "";
            height: 20px; /* Size of the circle */
            left: 3px; /* Start position */
            position: absolute;
            transition: transform 0.3s ease-in-out;
            width: 20px; /* Size of the circle */
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        input:checked + .slider {
            background-color: #4f46e5; /* indigo-600 */
        }
        .dark .slider {
             background-color: #374151; /* gray-700 */
        }
         .dark input:checked + .slider {
            background-color: #4338ca; /* indigo-700 */
        }
         .dark .slider:before {
             background-color: #e5e7eb; /* gray-200 */
         }

        input:checked + .slider:before {
            transform: translateX(24px); /* Move circle to the right */
        }

        /* Icons inside the slider */
        .slider svg {
            height: 16px;
            width: 16px;
            transition: opacity 0.3s ease-in-out;
        }
        .sun-icon {
            color: #f59e0b; /* amber-500 */
            opacity: 1;
        }
        .moon-icon {
             color: #93c5fd; /* blue-300 */
             opacity: 0;
        }
        input:checked + .slider .sun-icon {
            opacity: 0;
        }
         input:checked + .slider .moon-icon {
            opacity: 1;
        }

         /* Smooth transition for main container */
         .main-container {
             transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out;
         }
         /* Style for processed image display */
         #processedImage {
             max-width: 100%;
             max-height: 300px; /* Limit height */
             margin-top: 1rem;
             border-radius: 0.375rem; /* rounded-md */
             border: 1px solid #d1d5db; /* gray-300 */
         }
         .dark #processedImage {
             border-color: #4b5563; /* gray-600 */
         }

    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen flex items-center justify-center p-4">

    <div class="main-container bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md w-full max-w-lg">

        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-200">Veridia Vision Testing</h1>
             <div class="theme-switch-wrapper">
                <label class="theme-switch" for="themeToggleCheckbox">
                    <input type="checkbox" id="themeToggleCheckbox" />
                    <div class="slider">
                         <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.166 7.758a.75.75 0 001.06 1.06l1.59-1.591a.75.75 0 00-1.06-1.06L6.166 7.758z"></path></svg>
                         <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10.503 10.503 0 01-9.694 6.46c-5.799 0-10.5-4.701-10.5-10.5 0-3.51 1.713-6.63 4.362-8.542a.75.75 0 01.819.162z" clip-rule="evenodd"></path></svg>
                    </div>
                </label>
            </div>
        </div>
         <p class="text-center text-sm text-gray-500 dark:text-gray-400 mb-6 -mt-4">(Gemini 2.5 Flash - Camera)</p>

        <div class="mb-6 h-64 bg-gray-200 dark:bg-black rounded-md flex items-center justify-center overflow-hidden border border-gray-300 dark:border-gray-700">
            <video id="videoFeed" autoplay playsinline muted></video>
            <span id="cameraStatus" class="text-gray-400 dark:text-gray-500 p-4 text-center">Requesting camera access...</span>
        </div>
        <canvas id="snapshotCanvas"></canvas>

        <button id="analyzeButton" class="w-full bg-green-500 hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
            Capture & Analyze
        </button>

        <div id="statusMessage" class="mt-4 text-center text-sm text-gray-600 dark:text-gray-400 h-5"></div>

        <div id="resultsArea" class="mt-6">
            <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">Analysis Results:</h2>
            <div id="processedImageContainer" class="mb-4 text-center">
                 <img id="processedImage" src="#" alt="Processed Image" class="hidden mx-auto">
            </div>
            <div id="resultsContent" class="space-y-3">
                <p class="text-gray-500 dark:text-gray-400 text-sm">Point your camera at an item and click 'Capture & Analyze'.</p>
            </div>
        </div>
    </div>

    <script>
        const videoFeed = document.getElementById('videoFeed');
        const cameraStatus = document.getElementById('cameraStatus');
        const analyzeButton = document.getElementById('analyzeButton');
        const statusMessage = document.getElementById('statusMessage');
        const resultsContent = document.getElementById('resultsContent');
        const snapshotCanvas = document.getElementById('snapshotCanvas');
        const processedImage = document.getElementById('processedImage'); // Get image element
        const processedImageContainer = document.getElementById('processedImageContainer'); // Get container
        const ctx = snapshotCanvas.getContext('2d');
        const themeToggle = document.getElementById('themeToggleCheckbox');

        let currentStream = null;

        // --- Function to Apply Theme ---
        function applyTheme(isDark) {
            // console.log(`Applying theme: ${isDark ? 'dark' : 'light'}`);
            if (isDark) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            // console.log('Current html classes:', document.documentElement.className);
        }

        // --- Function to Start Camera ---
        async function startCamera() {
            // console.log('Attempting to start camera...');
             try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                 });
                 // console.log('Camera stream obtained.');
                currentStream = stream;
                videoFeed.srcObject = stream;
                videoFeed.onloadedmetadata = () => {
                    // console.log('Video metadata loaded.');
                    cameraStatus.classList.add('hidden');
                    videoFeed.classList.remove('hidden');
                    analyzeButton.disabled = false;
                    statusMessage.textContent = 'Camera active. Ready to analyze.';
                    snapshotCanvas.width = videoFeed.videoWidth;
                    snapshotCanvas.height = videoFeed.videoHeight;
                     // console.log(`Canvas dimensions set: ${snapshotCanvas.width}x${snapshotCanvas.height}`);
                };
            } catch (error) {
                console.error("Error accessing camera:", error);
                let errorMsg = 'Error accessing camera.';
                if (error.name === 'NotAllowedError') { errorMsg = 'Camera permission denied.'; }
                else if (error.name === 'NotFoundError') { errorMsg = 'No camera found.'; }
                else { errorMsg = `Error: ${error.name}`; }
                cameraStatus.textContent = errorMsg;
                cameraStatus.classList.remove('hidden');
                videoFeed.classList.add('hidden');
                statusMessage.textContent = 'Camera unavailable.';
                analyzeButton.disabled = true;
            }
        }

        // --- Event Listener for Analyze Button ---
        analyzeButton.addEventListener('click', async function() {
            // console.log('Analyze button clicked.');
             if (!currentStream || !videoFeed.srcObject) {
                 // console.warn('Analyze clicked but stream not available.');
                statusMessage.textContent = 'Error: Camera stream not available.';
                return;
            }
            analyzeButton.disabled = true;
            statusMessage.innerHTML = '<span class="spinner"></span> Capturing & Analyzing...'; // Updated status
            resultsContent.innerHTML = ''; // Clear previous text results
            processedImage.classList.add('hidden'); // Hide previous processed image
            processedImage.src = '#'; // Clear previous image src


            try {
                // Ensure canvas dimensions match video before drawing
                if (snapshotCanvas.width !== videoFeed.videoWidth || snapshotCanvas.height !== videoFeed.videoHeight) {
                    snapshotCanvas.width = videoFeed.videoWidth;
                    snapshotCanvas.height = videoFeed.videoHeight;
                }

                // console.log('Drawing video frame to canvas...');
                ctx.save();
                ctx.scale(-1, 1); // Flip horizontally to match mirrored preview
                ctx.drawImage(videoFeed, -snapshotCanvas.width, 0, snapshotCanvas.width, snapshotCanvas.height);
                ctx.restore(); // Restore context to normal
                const imageDataUrl = snapshotCanvas.toDataURL('image/jpeg', 0.9); // Use JPEG
                 // console.log('Snapshot captured.');

                // --- !!! ACTUAL API CALL !!! ---
                // Replace the simulation with a fetch call to the backend
                console.log("Sending image data to backend (/process_frame)...");

                // Prepare the payload, including the flag for the test model
                const payload = {
                    image_data: imageDataUrl,
                    use_test_model: true // <<< THIS FLAG TELLS THE BACKEND TO USE 2.5 FLASH
                };

                const response = await fetch('/process_frame', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                analyzeButton.disabled = false; // Re-enable button early

                if (!response.ok) {
                    // Try to get error details from response body
                    let errorData = { error: `HTTP error! status: ${response.status}`, status: `Request failed.` };
                    try {
                         errorData = await response.json();
                    } catch(e) { /* Ignore if response body is not JSON */ }
                    console.error('Backend error:', errorData);
                    throw new Error(errorData.status || `HTTP error! status: ${response.status}`);
                }

                const resultData = await response.json();
                console.log("Received response from backend:", resultData);

                // --- Display Results ---
                statusMessage.textContent = resultData.status || 'Analysis complete!'; // Display status from backend
                displayResults(resultData.object_details || []); // Display text details

                // Display the processed image (with bounding boxes if found)
                if (resultData.processed_image_data) {
                     processedImage.src = resultData.processed_image_data;
                     processedImage.classList.remove('hidden');
                } else {
                     processedImage.classList.add('hidden');
                }


            } catch (error) {
                console.error("Error during analysis fetch:", error);
                statusMessage.textContent = `Error: ${error.message}`;
                resultsContent.innerHTML = `<p class="text-red-500 dark:text-red-400 text-sm">Analysis failed: ${error.message}</p>`;
                processedImage.classList.add('hidden'); // Hide image on error
                analyzeButton.disabled = false; // Re-enable button on error
            }
            // Note: Button re-enabling moved earlier or into finally block if preferred
        });

        // --- Function to Display Results ---
        function displayResults(objectDetails) { // Changed parameter name
             // console.log('Displaying results:', objectDetails);
             resultsContent.innerHTML = ''; // Clear placeholder/previous
            if (!objectDetails || objectDetails.length === 0) {
                resultsContent.innerHTML = '<p class="text-gray-600 dark:text-gray-400">No objects identified in the snapshot.</p>';
                // Keep processed image visible even if no objects, as it might show the original
                // processedImage.classList.add('hidden');
                return;
            }

            // If objects were found, ensure the image container shows the potentially boxed image
            // processedImage.classList.remove('hidden'); // Handled in the fetch response now

            objectDetails.forEach(item => {
                const objectName = item.name || 'Unknown Object'; // Use 'name' from backend response
                const label = item.classification || 'Unknown Classification'; // Use 'classification'
                let labelColorClass = 'text-gray-700 bg-gray-100 dark:text-gray-200 dark:bg-gray-600'; // Default
                if (label === 'recyclable') {
                    labelColorClass = 'text-blue-700 bg-blue-100 dark:text-blue-200 dark:bg-blue-700';
                } else if (label === 'organic') {
                    labelColorClass = 'text-green-700 bg-green-100 dark:text-green-200 dark:bg-green-700';
                } else if (label === 'non-recyclable') {
                    labelColorClass = 'text-red-700 bg-red-100 dark:text-red-200 dark:bg-red-700';
                } else if (label === 'human') {
                    labelColorClass = 'text-purple-700 bg-purple-100 dark:text-purple-200 dark:bg-purple-700';
                }
                const resultElement = document.createElement('div');
                resultElement.className = 'p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md shadow-sm';
                resultElement.innerHTML = `
                    <span class="font-medium text-gray-900 dark:text-gray-100">${objectName}</span>:
                    <span class="ml-2 inline-block px-2 py-0.5 rounded-full text-xs font-semibold ${labelColorClass}">${label.toUpperCase()}</span>
                `;
                resultsContent.appendChild(resultElement);
            });
        }

         // --- Event Listener for Theme Toggle ---
        themeToggle.addEventListener('change', function() {
            const isDark = this.checked;
            // console.log(`Theme toggle changed. Checked: ${isDark}`);
            applyTheme(isDark); // Apply the class
            localStorage.setItem('veridiaTheme', isDark ? 'dark' : 'light');
            // console.log("Saved theme preference to localStorage:", isDark ? 'dark' : 'light');
        });


        // --- Initialize Theme on Page Load ---
        function initializeTheme() {
             // console.log('Initializing theme...');
             const savedTheme = localStorage.getItem('veridiaTheme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            let isDark;

            if (savedTheme) { isDark = (savedTheme === 'dark'); }
            else { isDark = prefersDark; }
            // console.log(`Determined initial theme: ${isDark ? 'dark' : 'light'}`);

            applyTheme(isDark);
            themeToggle.checked = isDark;
            // console.log(`Set toggle checkbox state to: ${isDark}`);

            startCamera();
        }

        document.addEventListener('DOMContentLoaded', initializeTheme);


        // --- Optional: Clean up camera stream when leaving the page ---
        window.addEventListener('beforeunload', () => {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                // console.log("Camera stream stopped.");
            }
        });

    </script>

</body>
</html>
